<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wunschliste Versetzungsfirmen</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f3f4f6;min-height:100vh}
.sticky-bar{position:sticky;top:0;z-index:50;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:background .3s;padding:8px 16px}
.sticky-bar.ok{background:#16a34a}.sticky-bar.over{background:#dc2626}.sticky-bar.pending{background:#1e293b}
.sticky-top{display:flex;flex-direction:column;align-items:center;padding:8px 16px 2px}
.pts-num{font-size:3rem;font-weight:900;line-height:1}
.pts-sub{font-size:11px;font-weight:600;opacity:.8;text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.pills{display:flex;gap:6px;padding:4px 12px 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;justify-content:center}
.pill{display:flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px;white-space:nowrap}
.pill.ok{background:#22c55e;color:#fff}.pill.ng{background:#f97316;color:#fff}
/* Form Tabs */
.form-tabs{display:flex;background:#fff;border-bottom:2px solid #e5e7eb;position:sticky;top:0;z-index:40}
.form-tab{flex:1;padding:12px 8px;border:none;background:none;font-size:14px;font-weight:700;color:#6b7280;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s}
.form-tab.active{color:#6366f1;border-bottom-color:#6366f1}
.form-tab.locked{color:#9ca3af;cursor:default}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.08);margin-bottom:12px}
.card-body{padding:16px}
.section-title{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
label.lbl{font-size:12px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px}
input[type=text],input[type=email],input[type=datetime-local],select,textarea{width:100%;padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;outline:none;font-family:inherit;background:#fff}
input:focus,select:focus,textarea:focus{border-color:#6366f1}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.col2{grid-column:span 2}
.radio-group{display:flex;gap:16px;flex-wrap:wrap}
.radio-group label{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:500;color:#374151;cursor:pointer}
input[type=radio]{accent-color:#6366f1;width:16px;height:16px}
/* Besuche Checkboxen */
.visit-row{padding:10px 14px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:12px}
.visit-row:last-child{border-bottom:none}
.visit-cb{width:20px;height:20px;accent-color:#6366f1;cursor:pointer;flex-shrink:0}
.visit-name{font-size:13px;font-weight:600;color:#1f2937;flex:1}
.visit-name.checked{color:#6366f1}
.visit-count{font-size:12px;font-weight:700;padding:2px 8px;border-radius:999px;background:#ede9fe;color:#6366f1}
/* Versetzung Regler */
.company-row{padding:8px 12px;border-bottom:1px solid #f3f4f6}
.company-row:last-child{border-bottom:none}
.company-top{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.rank-badge{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0}
.rank-badge.active{background:#6366f1;color:#fff}.rank-badge.empty{background:#f3f4f6;color:#9ca3af}
.company-name{font-size:13px;font-weight:600;color:#1f2937;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}
.company-name:hover{color:#6366f1}
.link-ico{opacity:.3;flex-shrink:0}
.dup-label{font-size:11px;font-weight:700;color:#ef4444;flex-shrink:0}
.stepper-wrap{display:flex;align-items:center;gap:3px;flex-shrink:0}
.step-btn{width:28px;height:28px;border-radius:7px;border:2px solid #e5e7eb;background:#fff;font-size:17px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#6366f1;line-height:1;flex-shrink:0;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.step-btn:active{background:#ede9fe;border-color:#6366f1}
.num-input{width:46px;padding:3px 2px;text-align:center;font-size:14px;font-weight:700;border:2px solid #e5e7eb;border-radius:8px;outline:none}
.num-input:focus{border-color:#6366f1}.num-input.dup{border-color:#ef4444;background:#fef2f2}
.eye-btn{background:none;border:none;cursor:pointer;color:#d1d5db;padding:2px;flex-shrink:0;touch-action:manipulation}
.eye-btn:hover{color:#ef4444}
.slider-row{padding:2px 0 4px 28px}
.slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:#e5e7eb;border-radius:4px;cursor:pointer;touch-action:none;display:block}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;background:#6366f1;border-radius:50%;cursor:pointer;border:3px solid #fff;box-shadow:0 1px 5px rgba(0,0,0,.25)}
.slider::-moz-range-thumb{width:24px;height:24px;background:#6366f1;border-radius:50%;border:3px solid #fff;cursor:pointer;box-shadow:0 1px 5px rgba(0,0,0,.25)}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-primary{background:#6366f1;color:#fff}.btn-primary:hover{background:#4f46e5}
.btn-primary:disabled{background:#e5e7eb;color:#9ca3af;cursor:not-allowed}
.btn-blue{background:#3b82f6;color:#fff}.btn-blue:hover{background:#2563eb}
.btn-gray{background:#6b7280;color:#fff}.btn-gray:hover{background:#4b5563}
.btn-green{background:#16a34a;color:#fff}.btn-green:hover{background:#15803d}
.btn-red{background:#ef4444;color:#fff}.btn-red:hover{background:#dc2626}
.btn-teal{background:#0d9488;color:#fff}.btn-teal:hover{background:#0f766e}
.btn-sm{padding:7px 14px;font-size:13px;border-radius:8px;width:auto}
.btn-outline{background:#fff;border:2px solid #e5e7eb;color:#6b7280}.btn-outline:hover{background:#f9fafb}
.validation-row{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;padding:2px 0}
.validation-row.ok{color:#16a34a}.validation-row.ng{color:#ef4444}
.drawer-toggle{width:100%;background:none;border:none;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.06em;cursor:pointer}
.drawer-toggle:hover{background:#f9fafb}
.drawer-content{border-top:1px solid #f3f4f6}
.drawer-item{padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f3f4f6}
.drawer-item:last-child{border-bottom:none}
.selfie-wrap{border:2px dashed #a5b4fc;border-radius:12px;padding:24px;text-align:center;cursor:pointer;background:#f5f3ff;transition:background .2s}
.selfie-wrap:hover{background:#ede9fe}
.selfie-preview{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px}
video#selfie-video{width:100%;border-radius:12px;background:#000;max-height:220px;object-fit:cover}
.spinner{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-bar-bg{background:#e5e7eb;border-radius:999px;height:16px;overflow:hidden;margin:8px 0}
.progress-bar-fill{height:100%;background:#6366f1;border-radius:999px;transition:width .5s}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;margin-top:12px}
.stat-num{font-size:1.8rem;font-weight:900}.stat-lbl{font-size:11px;color:#9ca3af;margin-top:2px}
.admin-tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab-btn{padding:8px 16px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s}
.tab-btn.active{background:#6366f1;color:#fff}
.tab-btn.inactive{background:#fff;color:#6b7280;box-shadow:0 1px 3px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:8px 6px;background:#f9fafb;border-bottom:2px solid #e5e7eb;text-align:left;font-weight:700;color:#374151;white-space:nowrap}
td{padding:7px 6px;border-bottom:1px solid #f3f4f6;color:#374151}
tr:hover td{background:#f9fafb}
.tbl-wrap{overflow-x:auto}
.info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;font-size:12px;color:#1d4ed8;line-height:1.6;min-height:56px;display:flex;flex-direction:column;justify-content:center}
.info-box-amber{background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;padding:12px;font-size:12px;color:#92400e;line-height:1.6}
.success-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
.success-card{background:#fff;border-radius:20px;padding:32px;max-width:400px;width:100%;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,.1)}
.check-circle{width:64px;height:64px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.main-wrap{max-width:600px;margin:0 auto;padding:12px}
.company-header{padding:10px 16px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;justify-content:space-between}
.deadlined{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
.import-hint{font-size:11px;color:#9ca3af;margin-bottom:6px;line-height:1.5}
textarea.mono{font-family:monospace;font-size:12px}
.locked-banner{background:#f1f5f9;border:2px solid #cbd5e1;border-radius:12px;padding:20px;text-align:center;margin-bottom:12px}
</style>
</head>
<body>
<div id="app">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center">
    <div style="text-align:center"><div class="spinner" style="margin-bottom:12px"></div><p style="color:#6b7280;font-size:14px">Verbindung wird hergestelltâ€¦</p></div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, onSnapshot, getDoc }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const fireApp = initializeApp({
  apiKey:"AIzaSyDfW6L8LP1UW-opMlX1DoqM_Y58qQUOYpQ",
  authDomain:"wunschliste-versetzungsfirmen.firebaseapp.com",
  projectId:"wunschliste-versetzungsfirmen",
  storageBucket:"wunschliste-versetzungsfirmen.firebasestorage.app",
  messagingSenderId:"511185053099",
  appId:"1:511185053099:web:11561dfcafce8ab8021eee"
});
const db = getFirestore(fireApp);

const FB = {
  // Besuche
  subscribeBes: (cb) => onSnapshot(collection(db,'besuche'), snap => cb(snap.docs.map(d=>({_id:d.id,...d.data()})))),
  saveBes: (sub) => { const id=sub.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase()+'_bes'; return setDoc(doc(db,'besuche',id),sub); },
  delBes: (id) => deleteDoc(doc(db,'besuche',id)),
  delAllBes: async () => { const s=await getDocs(collection(db,'besuche')); return Promise.all(s.docs.map(d=>deleteDoc(d.ref))); },
  // Versetzung
  subscribeVer: (cb) => onSnapshot(collection(db,'submissions'), snap => cb(snap.docs.map(d=>({_id:d.id,...d.data()})))),
  saveVer: (sub) => { const id=sub.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase(); return setDoc(doc(db,'submissions',id),sub); },
  delVer: (id) => deleteDoc(doc(db,'submissions',id)),
  delAllVer: async () => { const s=await getDocs(collection(db,'submissions')); return Promise.all(s.docs.map(d=>deleteDoc(d.ref))); },
  // Config
  loadSetup: async () => { const d=await getDoc(doc(db,'config','setup')); return d.exists()?d.data():null; },
  saveSetup: (cfg) => setDoc(doc(db,'config','setup'),cfg),
};

const ADMIN_PW_HASH = '1ac6aaaa80a6eddcffc50b4f7579b329ae1966dc3fb417647971cdd17ca9eb57';

const DEFAULT_COMPANIES = [
  {id:1,name:'ANDRITZ Soutec AG',url:'https://www.andritz.com'},
  {id:2,name:'Burckhardt Compression AG',url:'https://www.burckhardtcompression.com'},
  {id:3,name:'Corvaglia Mould AG',url:'https://www.corvaglia.ch'},
  {id:4,name:'ElektrizitÃ¤tswerk der Stadt ZH',url:'https://www.ewz.ch'},
  {id:5,name:'Fehr Lagerlogistik',url:'https://www.fehr.net'},
  {id:6,name:'Heim AG Heizsysteme',url:'https://www.heim-ag.ch'},
  {id:7,name:'HFS Aqua AG',url:'https://www.hfs-aqua.ch'},
  {id:8,name:'Hug Engineering AG',url:'https://www.hug-engineering.com'},
  {id:9,name:'Kanadevia Inova AG',url:'https://www.kanadevia-inova.com'},
  {id:10,name:'KELLER Pressure AG',url:'https://www.keller-pressure.com'},
  {id:11,name:'Linde Kryotechnik AG',url:'https://www.linde-kryotechnik.ch'},
  {id:12,name:'Nobel Biocare Services AG',url:'https://www.nobelbiocare.com'},
  {id:13,name:'Stadler Winterthur AG',url:'https://www.stadlerrail.com'},
  {id:14,name:'Sulzer Chemtech AG',url:'https://www.sulzer.com/en/shared/about-us/chemtech'},
  {id:15,name:'Sulzer Management AG',url:'https://www.sulzer.com/de-ch/products/pumps'},
  {id:16,name:'TEDAG Dichtungstechnik AG',url:'https://www.tedag.ch'},
  {id:17,name:'WinGD Ltd.',url:'https://www.wingd.com'},
  {id:18,name:'ZHAW School of Engineering',url:'https://www.zhaw.ch'},
  {id:19,name:'Zimmer Biomet GmbH',url:'https://www.zimmerbiomet.ch'},
];

const DEFAULT_SETUP = {
  companies: DEFAULT_COMPANIES,
  students: [],
  besVon: '',      // Besuche sichtbar ab
  besBis: '',      // Besuche sichtbar bis
  verVon: '',      // Versetzung sichtbar ab
  verBis: '',      // Versetzung sichtbar bis
};

let state = {
  view: 'form',         // form | success_bes | success_ver | admin
  formTab: 'besuche',   // besuche | versetzung
  adminTab: 'besuche',  // besuche | versetzung | setup
  subsBes: [],
  subsVer: [],
  setup: { ...DEFAULT_SETUP },
  // Gemeinsame Angaben
  personal: { name:'', plz:'', ort:'', email:'', bms:'', schultage:'', ferien:'', ferienText:'', selfie:'', datenschutz:false },
  // Besuche
  besuche: { selected:[] },   // Array von IDs
  // Versetzung
  versetzung: { points:{}, hidden:[], orderedIds:DEFAULT_COMPANIES.map(c=>c.id), sortApplied:false },
  selfieStreaming:false, selfieReady:false, selfieStream:null,
  showHidden:false, showLoginModal:false, loginPw:'', loginErr:false, loading:true,
};

const emptyPoints = (cos) => cos.reduce((a,c)=>({...a,[c.id]:0}),{});

// â”€â”€ SVG Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const checkSvg=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`;
const warnSvg=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
const eyeOffSvg=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`;
const eyeOnSvg=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;
const lockSvg=(s=18)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`;
const camSvg=(s=24)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`;
const trashSvg=(s=13)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>`;
const sortSvg=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="9" y2="18"/></svg>`;
const chevD=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`;
const chevU=(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>`;
const linkSvg=(s=10)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;
const dlSvg=(s=16)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const now = () => new Date();
function besIsVisible() {
  const s=state.setup;
  if(!s.besVon && !s.besBis) return true;
  const after  = !s.besVon || now() >= new Date(s.besVon);
  const before = !s.besBis || now() <= new Date(s.besBis);
  return after && before;
}
function besDeadlinePassed() {
  return state.setup.besBis && now() > new Date(state.setup.besBis);
}
function verIsVisible() {
  const s=state.setup;
  if(!s.verVon && !s.verBis) return true;
  const after  = !s.verVon || now() >= new Date(s.verVon);
  const before = !s.verBis || now() <= new Date(s.verBis);
  return after && before;
}
function verDeadlinePassed() {
  return state.setup.verBis && now() > new Date(state.setup.verBis);
}

// â”€â”€ Computed Versetzung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computedVer() {
  const v=state.versetzung, pts=v.points, p=state.personal;
  const total=Object.values(pts).reduce((a,b)=>a+Number(b||0),0);
  const withPoints=Object.values(pts).filter(v=>v>0).length;
  const nonZeroDup=()=>{const vals=Object.entries(pts).filter(([id,vv])=>vv>0&&!v.hidden.includes(Number(id))).map(([,vv])=>vv);return vals.length!==new Set(vals).size;};
  const rankMap={};
  Object.entries(pts).filter(([,vv])=>vv>0).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([id],i)=>{rankMap[Number(id)]=i+1;});
  const deadlinePassed=verDeadlinePassed();
  const angaben=!!(p.name&&p.plz&&/^[0-9]{4}$/.test(p.plz)&&p.ort&&p.email&&p.bms&&p.schultage&&p.ferien&&(p.ferien!=='Ja'||p.ferienText)&&p.selfie);
  const valid=total===100&&!nonZeroDup()&&withPoints===8&&angaben&&p.datenschutz&&!deadlinePassed;
  return{total,remaining:100-total,withPoints,nonZeroDup:nonZeroDup(),rankMap,valid,deadlinePassed,angaben};
}

// â”€â”€ Computed Besuche â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computedBes() {
  const sel=state.besuche.selected, p=state.personal;
  const count=sel.length;
  const angaben=!!(p.name&&p.plz&&/^[0-9]{4}$/.test(p.plz)&&p.ort&&p.email&&p.bms&&p.schultage&&p.ferien&&(p.ferien!=='Ja'||p.ferienText)&&p.selfie);
  const deadlinePassed=besDeadlinePassed();
  const valid=count===8&&angaben&&p.datenschutz&&!deadlinePassed;
  return{count,valid,deadlinePassed,angaben};
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const appEl=document.getElementById('app');
  if(state.loading){appEl.innerHTML=`<div style="min-height:100vh;display:flex;align-items:center;justify-content:center"><div style="text-align:center"><div class="spinner" style="margin-bottom:12px"></div><p style="color:#6b7280;font-size:14px">Verbindung wird hergestelltâ€¦</p></div></div>`;return;}
  if(state.view==='admin'){renderAdmin();return;}
  if(state.view==='success_bes'){renderSuccessBes();return;}
  if(state.view==='success_ver'){renderSuccessVer();return;}
  renderForm();
}

// â”€â”€ Schnelle Banner-Updates (kein Re-Render beim Slider) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _sliderTimer=null;
function applyPointUpdate(id,n){
  state.versetzung.points[id]=n;
  document.querySelectorAll(`[data-cid="${id}"]`).forEach(el=>{if(el!==document.activeElement)el.value=n;});
  const pts=state.versetzung.points, hidden=state.versetzung.hidden;
  state.setup.companies.forEach(co=>{
    const cid=co.id, val=pts[cid]||0;
    const isDup=val>0&&!hidden.includes(cid)&&Object.entries(pts).some(([oid,ov])=>Number(oid)!==cid&&ov===val&&!hidden.includes(Number(oid)));
    const numIn=document.querySelector(`.num-input[data-cid="${cid}"]`);
    if(numIn)numIn.classList.toggle('dup',isDup);
    const existDup=document.querySelector(`.company-row[data-id="${cid}"] .dup-label`);
    if(isDup&&!existDup){const top=document.querySelector(`.company-row[data-id="${cid}"] .company-top`);if(top&&numIn){const sp=document.createElement('span');sp.className='dup-label';sp.textContent='Duplikat!';top.insertBefore(sp,numIn);}}
    else if(!isDup&&existDup){existDup.remove();}
  });
  updateVerBannerFast();
  clearTimeout(_sliderTimer);
  _sliderTimer=setTimeout(()=>render(),150);
}

function updateVerBannerFast(){
  const pts=state.versetzung.points, hidden=state.versetzung.hidden;
  const total=Object.values(pts).reduce((a,b)=>a+Number(b||0),0);
  const withPoints=Object.values(pts).filter(v=>v>0).length;
  const vals=Object.entries(pts).filter(([id,v])=>v>0&&!hidden.includes(Number(id))).map(([,v])=>v);
  const nonZeroDup=vals.length!==new Set(vals).size;
  const p=state.personal;
  const angaben=!!(p.name&&p.plz&&/^[0-9]{4}$/.test(p.plz)&&p.ort&&p.email&&p.bms&&p.schultage&&p.ferien&&(p.ferien!=='Ja'||p.ferienText)&&p.selfie);
  const bar=document.querySelector('.sticky-bar');
  if(bar)bar.className='sticky-bar '+(total===100?'ok':total>100?'over':'pending');
  const pn=document.querySelector('.pts-num');if(pn)pn.textContent=`${total}/100`;
  const pills=document.querySelectorAll('.pill');
  if(pills.length>=3){
    const setP=(el,ok,label)=>{el.className='pill '+(ok?'ok':'ng');const icon=ok?`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`:`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;el.innerHTML=icon+' '+label;};
    setP(pills[0],withPoints===8,`${withPoints}/8 Firmen`);
    setP(pills[1],!nonZeroDup,!nonZeroDup?'Keine Duplikate':'Duplikate!');
    setP(pills[2],angaben,angaben?'Angaben vollstÃ¤ndig':'Angaben unvollstÃ¤ndig');
  }
  const rankMap={};
  Object.entries(pts).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([id],i)=>{rankMap[Number(id)]=i+1;});
  document.querySelectorAll('.company-row').forEach(row=>{
    const cid=Number(row.dataset.id), badge=row.querySelector('.rank-badge');
    if(badge){const rank=rankMap[cid];badge.className='rank-badge '+(rank?'active':'empty');badge.textContent=rank||'';}
  });
}

// â”€â”€ Selfie HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSelfieHtml(p){
  if(p.selfie)return`<img src="${p.selfie}" class="selfie-preview" style="margin-bottom:8px"/><button onclick="resetSelfie()" style="font-size:12px;font-weight:600;color:#6366f1;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:4px">${camSvg(13)} Neues Verifizierungsfoto aufnehmen</button>`;
  if(state.selfieStreaming)return`<video id="selfie-video" autoplay muted playsinline style="width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#000;margin-bottom:8px"></video>${!state.selfieReady?`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;color:#6b7280;font-size:13px"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div>Kamera wird gestartetâ€¦</div>`:''}<div style="display:flex;gap:8px"><button onclick="captureSelfie()" ${state.selfieReady?'':'disabled'} class="btn btn-primary btn-sm" style="flex:1;${state.selfieReady?'':'opacity:.5;cursor:not-allowed'}">${camSvg(16)} ${state.selfieReady?'Aufnehmen':'Warteâ€¦'}</button><button onclick="stopCamera()" class="btn btn-outline btn-sm">âœ•</button></div>`;
  return`<div class="selfie-wrap" onclick="startCamera()">${camSvg(32)}<p style="font-size:13px;font-weight:600;color:#6366f1;margin-top:8px">Verifizierungsfoto aufnehmen (Frontkamera)</p></div>`;
}

// â”€â”€ PersÃ¶nliche Angaben HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPersonalHtml(p){
  let nameField='';
  if(state.setup.students&&state.setup.students.length>0){
    nameField=`<select onchange="setPersonal('name',this.value)" style="width:100%;padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;background:#fff"><option value="">-- Name auswÃ¤hlen --</option>${state.setup.students.map(s=>`<option value="${s}" ${p.name===s?'selected':''}>${s}</option>`).join('')}</select>`;
  } else {
    nameField=`<input type="text" value="${p.name}" placeholder="Vorname Nachname" oninput="livePersonal('name',this.value)" onblur="commitPersonal()" autocomplete="name"/>`;
  }
  return`<div class="card"><div class="card-body">
    <p class="section-title">PersÃ¶nliche Angaben</p>
    <div style="margin-bottom:10px"><label class="lbl">Name *</label>${nameField}</div>
    <div class="grid2">
      <div><label class="lbl">PLZ *</label><input tabindex="1" type="text" value="${p.plz}" placeholder="8400" maxlength="4" oninput="livePersonal('plz',this.value)" onblur="commitPersonal()" inputmode="numeric" style="border-color:${p.plz&&!/^[0-9]{4}$/.test(p.plz)?'#ef4444':''}"/></div>
      <div><label class="lbl">Ort *</label><input tabindex="2" type="text" value="${p.ort}" placeholder="Winterthur" oninput="livePersonal('ort',this.value)" onblur="commitPersonal()"/></div>
      <div class="col2"><label class="lbl">E-Mail *</label><input tabindex="3" type="email" value="${p.email}" placeholder="max@mail.ch" oninput="livePersonal('email',this.value)" onblur="commitPersonal()" autocomplete="email"/></div>
    </div>
    <div style="margin-top:12px;display:flex;flex-direction:column;gap:12px">
      <div><p class="lbl">BMS *</p><div class="radio-group">
        <label><input tabindex="4" type="radio" name="bms" ${p.bms==='Ja'?'checked':''} onchange="setPersonal('bms','Ja')"/> Ja</label>
        <label><input tabindex="5" type="radio" name="bms" ${p.bms==='Nein'?'checked':''} onchange="setPersonal('bms','Nein')"/> Nein</label>
      </div></div>
      <div><p class="lbl">Schultage *</p><div class="radio-group">
        <label><input tabindex="6" type="radio" name="schultage" ${p.schultage==='Mo/Di'?'checked':''} onchange="setPersonal('schultage','Mo/Di')"/> Montag / Dienstag</label>
        <label><input tabindex="7" type="radio" name="schultage" ${p.schultage==='Do/Fr'?'checked':''} onchange="setPersonal('schultage','Do/Fr')"/> Donnerstag / Freitag</label>
      </div></div>
      <div><p class="lbl">FrÃ¼hlingsferien *</p><div class="radio-group">
        <label><input tabindex="8" type="radio" name="ferien" ${p.ferien==='Ja'?'checked':''} onchange="setPersonal('ferien','Ja')"/> Ja</label>
        <label><input tabindex="9" type="radio" name="ferien" ${p.ferien==='Nein'?'checked':''} onchange="setPersonal('ferien','Nein')"/> Nein</label>
      </div></div>
      ${p.ferien==='Ja'?`<div><label class="lbl">Zeitraum FrÃ¼hlingsferien *</label><input tabindex="10" type="text" value="${p.ferienText}" placeholder="z.B. 14.04.â€“25.04.2025" oninput="livePersonal('ferienText',this.value)" onblur="commitPersonal()"/></div>`:''}
    </div>
    <div style="margin-top:14px"><p class="lbl">Verifizierungsfoto (Frontkamera) *</p>${buildSelfieHtml(p)}</div>
  </div></div>`;
}

// â”€â”€ renderForm (Besuche + Versetzung Tabs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForm(){
  const appEl=document.getElementById('app');
  const p=state.personal;
  const cvB=computedBes();
  const besVisible=besIsVisible();
  const verVisible=verIsVisible();

  const tabsHtml=`<div class="form-tabs">
    <button class="form-tab ${state.formTab==='besuche'?'active':''}${!besVisible?' locked':''}" onclick="${besVisible?"setFormTab('besuche')":'showBesLocked()'}" ${!besVisible?'title="Noch nicht freigeschaltet"':''}>
      ğŸ­ WÃ¼nsche Besuche${!besVisible?' ğŸ”’':''}
    </button>
    <button class="form-tab ${state.formTab==='versetzung'?'active':''}${!verVisible?' locked':''}" onclick="${verVisible?"setFormTab('versetzung')":'showVerLocked()'}" ${!verVisible?'title="Noch nicht freigeschaltet"':''}>
      ğŸ“Š WÃ¼nsche Versetzung${!verVisible?' ğŸ”’':''}
    </button>
  </div>`;

  if(state.formTab==='besuche'){
    renderFormBesuche(appEl, p, cvB, tabsHtml);
  } else {
    renderFormVersetzung(appEl, p, tabsHtml);
  }
  if(state.selfieStreaming){const vid=document.getElementById('selfie-video');if(vid&&state.selfieStream){vid.srcObject=state.selfieStream;vid.play().catch(()=>{});}}
}

// â”€â”€ Besuche Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFormBesuche(appEl, p, cv, tabsHtml){
  const cos=state.setup.companies;
  const sel=state.besuche.selected;
  const s=state.setup;

  // Abgelaufen?
  if(besDeadlinePassed()){
    appEl.innerHTML=`${tabsHtml}<div class="main-wrap"><div style="padding:40px 0;text-align:center"><div class="success-card" style="margin:0 auto"><div style="font-size:3rem;margin-bottom:12px">ğŸ”’</div><h2 style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:8px">Eingabefrist abgelaufen</h2><p style="color:#6b7280;font-size:13px">Die BesuchswÃ¼nsche konnten bis ${new Date(s.besBis).toLocaleDateString('de-DE')} eingereicht werden.</p></div></div></div>`;
    return;
  }

  const cosHtml=cos.map(co=>{
    const checked=sel.includes(co.id);
    const disabled=!checked&&sel.length>=8;
    return`<div class="visit-row">
      <input type="checkbox" class="visit-cb" ${checked?'checked':''} ${disabled?'disabled':''} onchange="toggleBesuche(${co.id},this.checked)" style="${disabled?'opacity:.35;cursor:not-allowed':''}"/>
      <a href="${co.url}" target="_blank" class="visit-name ${checked?'checked':''}" style="${disabled?'color:#9ca3af':''}">${co.name}</a>
      <span class="link-ico">${linkSvg(9)}</span>
    </div>`;
  }).join('');

  const provisional=cv.count===8&&p.name;

  appEl.innerHTML=`
  <div class="sticky-bar ${cv.count===8?'ok':'pending'}">
    <div class="sticky-top">
      <span class="pts-num">${cv.count}/8</span>
      <span class="pts-sub">Firmen ausgewÃ¤hlt</span>
    </div>
    <div class="pills">
      <div class="pill ${cv.count===8?'ok':'ng'}">${cv.count===8?checkSvg(10):warnSvg(10)} ${cv.count}/8 Firmen</div>
      <div class="pill ${cv.angaben?'ok':'ng'}">${cv.angaben?checkSvg(10):warnSvg(10)} ${cv.angaben?'Angaben vollstÃ¤ndig':'Angaben unvollstÃ¤ndig'}</div>
    </div>
  </div>
  ${tabsHtml}
  <div class="main-wrap">
    <div class="card" style="margin-top:0"><div class="card-body">
      <h1 style="font-size:17px;font-weight:800;color:#1f2937;margin-bottom:4px">WÃ¼nsche Firmenbesuche</h1>
      <p style="font-size:13px;color:#6b7280;margin-bottom:10px">WÃ¤hle genau 8 Firmen aus, die du besuchen mÃ¶chtest.</p>
      <div class="info-box"><div>â€¢ Genau 8 Firmen mÃ¼ssen ausgewÃ¤hlt werden</div><div style="opacity:0;height:0;overflow:hidden">â€¢ Platzhalter</div></div>
      ${s.besVon?`<p style="font-size:12px;color:#6b7280;font-weight:600;margin-top:6px">ğŸ“… Sichtbar ab: ${new Date(s.besVon).toLocaleDateString('de-DE')}</p>`:''}
      ${s.besBis?`<p style="font-size:12px;color:#ea580c;font-weight:600;margin-top:4px">â° Eingabe mÃ¶glich bis: ${new Date(s.besBis).toLocaleDateString('de-DE')}</p>`:''}
    </div></div>

    ${buildPersonalHtml(p)}

    <div class="card">
      <div class="company-header">
        <p class="section-title" style="margin:0">Firmen auswÃ¤hlen</p>
        <span class="visit-count">${cv.count}/8</span>
      </div>
      <div>${cosHtml}</div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      <button class="btn btn-teal" onclick="saveProvisionalBes()" ${provisional?'':'disabled'} style="${provisional?'':'opacity:.4;cursor:not-allowed'}">
        ğŸ“¸ Besuchsliste provisorisch speichern
      </button>
      <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:10px;padding:12px 14px;display:flex;align-items:flex-start;gap:10px">
        <input type="checkbox" id="datenschutz-cb" ${p.datenschutz?'checked':''} onchange="setPersonal('datenschutz',this.checked)" style="margin-top:3px;width:18px;height:18px;flex-shrink:0;accent-color:#6366f1;cursor:pointer"/>
        <label for="datenschutz-cb" style="font-size:12px;color:#374151;line-height:1.5;cursor:pointer">
          Hiermit stimme ich zu, dass meine Daten bis zur definitiven Zuteilung der Firmen gespeichert werden dÃ¼rfen. Die Daten, insbesondere das Verifizierungsfoto werden vertraulich behandelt.
        </label>
      </div>
      <button class="btn btn-primary" onclick="handleSubmitBes()" ${cv.valid?'':'disabled'} style="${cv.valid?'':'opacity:.5;cursor:not-allowed'}">
        ${cv.valid?'BesuchswÃ¼nsche einreichen âœ“':'Bitte alle Anforderungen erfÃ¼llen'}
      </button>
    </div>
  </div>
  <button onclick="showLogin()" style="position:fixed;bottom:20px;right:20px;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;color:#9ca3af">${lockSvg(18)}</button>
  ${state.showLoginModal?renderLoginModal():''}`;
}

// â”€â”€ Versetzung Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFormVersetzung(appEl, p, tabsHtml){
  const cv=computedVer();
  const v=state.versetzung;
  const s=state.setup;
  const cos=state.setup.companies;

  if(verDeadlinePassed()){
    appEl.innerHTML=`${tabsHtml}<div class="main-wrap"><div style="padding:40px 0;text-align:center"><div class="success-card" style="margin:0 auto"><div style="font-size:3rem;margin-bottom:12px">ğŸ”’</div><h2 style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:8px">Eingabefrist abgelaufen</h2><p style="color:#6b7280;font-size:13px">Die Wunschliste Versetzung konnte bis ${new Date(state.setup.verBis).toLocaleDateString('de-DE')} eingereicht werden.</p></div></div></div>`;
    return;
  }

  // Companies HTML
  const hiddenCos=cos.filter(c=>v.hidden.includes(c.id));
  let hiddenHtml='';
  hiddenCos.forEach(co=>{hiddenHtml+=`<div class="drawer-item"><a href="${co.url}" target="_blank" style="font-size:13px;color:#9ca3af;text-decoration:line-through;display:flex;align-items:center;gap:4px">${co.name} ${linkSvg(9)}</a><button onclick="showCompany(${co.id})" style="display:flex;align-items:center;gap:4px;font-size:12px;font-weight:700;color:#6366f1;background:none;border:none;cursor:pointer;padding:4px 8px;border-radius:6px">${eyeOnSvg(13)} Einblenden</button></div>`;});

  const visibleIds=v.orderedIds.filter(id=>!v.hidden.includes(id));
  let cosHtml='';
  visibleIds.forEach(id=>{
    const co=cos.find(c=>c.id===id); if(!co)return;
    const val=v.points[id]||0, rank=cv.rankMap[id];
    const isDup=val>0&&Object.entries(v.points).some(([oid,ov])=>Number(oid)!==id&&ov===val&&!v.hidden.includes(Number(oid)));
    cosHtml+=`<div class="company-row" data-id="${id}">
      <div class="company-top">
        <div class="rank-badge ${rank?'active':'empty'}">${rank||''}</div>
        <a href="${co.url}" target="_blank" class="company-name">${co.name}</a>
        <span class="link-ico">${linkSvg(9)}</span>
        ${isDup?`<span class="dup-label">Duplikat!</span>`:''}
        <div class="stepper-wrap">
          <button class="step-btn" onclick="stepPoint(${id},-1)">âˆ’</button>
          <input class="num-input${isDup?' dup':''}" type="number" min="0" max="50" value="${val}" data-cid="${id}" oninput="setPointDirect(${id},this.value)" onchange="setPointDirect(${id},this.value)"/>
          <button class="step-btn" onclick="stepPoint(${id},1)">+</button>
        </div>
        <button class="eye-btn" onclick="hideCompanyNow(${id})" title="Ausblenden">${eyeOffSvg(14)}</button>
      </div>
      <div class="slider-row"><input type="range" min="0" max="50" value="${val}" class="slider" data-cid="${id}" oninput="setPointSlider(${id},this.value)" onchange="setPointSlider(${id},this.value)"/></div>
    </div>`;
  });

  const bannerClass=cv.total===100?'ok':cv.total>100?'over':'pending';
  const provisional=cv.total===100&&cv.withPoints===8&&p.name;

  appEl.innerHTML=`
  <div class="sticky-bar ${bannerClass}">
    <div class="sticky-top">
      <span class="pts-num">${cv.total}/100</span>
      <span class="pts-sub">Punkte verteilt</span>
    </div>
    <div class="pills">
      <div class="pill ${cv.withPoints===8?'ok':'ng'}">${cv.withPoints===8?checkSvg(10):warnSvg(10)} ${cv.withPoints}/8 Firmen</div>
      <div class="pill ${!cv.nonZeroDup?'ok':'ng'}">${!cv.nonZeroDup?checkSvg(10):warnSvg(10)} ${!cv.nonZeroDup?'Keine Duplikate':'Duplikate!'}</div>
      <div class="pill ${cv.angaben?'ok':'ng'}">${cv.angaben?checkSvg(10):warnSvg(10)} ${cv.angaben?'Angaben vollstÃ¤ndig':'Angaben unvollstÃ¤ndig'}</div>
    </div>
  </div>
  ${tabsHtml}
  <div class="main-wrap">
    <div class="card" style="margin-top:0"><div class="card-body">
      <h1 style="font-size:17px;font-weight:800;color:#1f2937;margin-bottom:4px">WÃ¼nsche Versetzungsfirmen</h1>
      <p style="font-size:13px;color:#6b7280;margin-bottom:10px">Verteile 100 Punkte auf genau 8 Firmen.</p>
      <div class="info-box"><div>â€¢ Genau 8 Firmen mÃ¼ssen mindestens 1 Punkt erhalten</div><div>â€¢ Keine zwei Firmen dÃ¼rfen gleich viele Punkte erhalten</div></div>
      ${state.setup.verVon?`<p style="font-size:12px;color:#6b7280;font-weight:600;margin-top:6px">ğŸ“… Sichtbar ab: ${new Date(state.setup.verVon).toLocaleDateString('de-DE')}</p>`:''}
      ${state.setup.verBis?`<p style="font-size:12px;color:#ea580c;font-weight:600;margin-top:4px">â° Eingabe mÃ¶glich bis: ${new Date(state.setup.verBis).toLocaleDateString('de-DE')}</p>`:''}
    </div></div>

    ${buildPersonalHtml(p)}

    <div class="card"><div class="card-body" style="padding:12px 16px">
      ${[
        {ok:cv.total===100,label:`100 Punkte verteilt (${cv.total}/100)`},
        {ok:cv.withPoints===8,label:`Genau 8 Firmen bewertet (${cv.withPoints}/8)${cv.withPoints>8?' â€“ zu viele!':''}`},
        {ok:!cv.nonZeroDup,label:'Keine doppelten Punktzahlen'},
        {ok:!!(p.name&&p.plz&&/^[0-9]{4}$/.test(p.plz)&&p.ort&&p.email),label:'Alle Pflichtfelder ausgefÃ¼llt (PLZ: 4 Ziffern)'},
        {ok:!!(p.bms&&p.schultage&&p.ferien),label:'BMS / Schultage / Ferien ausgefÃ¼llt'},
        {ok:!!p.selfie,label:'Verifizierungsfoto aufgenommen'},
      ].map(vv=>`<div class="validation-row ${vv.ok?'ok':'ng'}">${vv.ok?checkSvg(13):warnSvg(13)} ${vv.label}</div>`).join('')}
    </div></div>

    <div class="card">
      <div class="company-header"><p class="section-title" style="margin:0">Punkte verteilen</p><span style="font-size:12px;color:#9ca3af;font-weight:600">${cv.withPoints}/8 bewertet</span></div>
      <div id="companies-list">${cosHtml}</div>
    </div>

    ${hiddenCos.length>0?`<div class="card">
      <button class="drawer-toggle" onclick="toggleHiddenDrawer()"><span>Ausgeblendete Firmen (${hiddenCos.length})</span>${state.showHidden?chevU():chevD()}</button>
      ${state.showHidden?`<div class="drawer-content">${hiddenHtml}</div>`:''}
    </div>`:''}

    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      <button class="btn btn-gray" onclick="hideUnrated()">${eyeOffSvg(15)} Nicht bewertete Firmen ausblenden</button>
      <button class="btn btn-blue" onclick="doSort()">${sortSvg()} ${v.sortApplied?'âœ“ Nach Bewertung sortiert':'Nach Bewertung sortieren'}</button>
      <button class="btn btn-green" onclick="saveProvisionalVer()" ${provisional?'':'disabled'} style="${provisional?'':'opacity:.4;cursor:not-allowed'}">
        ğŸ“¸ Wunschliste provisorisch speichern
      </button>
      <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:10px;padding:12px 14px;display:flex;align-items:flex-start;gap:10px">
        <input type="checkbox" id="datenschutz-cb2" ${p.datenschutz?'checked':''} onchange="setPersonal('datenschutz',this.checked)" style="margin-top:3px;width:18px;height:18px;flex-shrink:0;accent-color:#6366f1;cursor:pointer"/>
        <label for="datenschutz-cb2" style="font-size:12px;color:#374151;line-height:1.5;cursor:pointer">
          Hiermit stimme ich zu, dass meine Daten bis zur definitiven Zuteilung der Firmen gespeichert werden dÃ¼rfen. Die Daten, insbesondere das Verifizierungsfoto werden vertraulich behandelt.
        </label>
      </div>
      <button class="btn btn-primary" onclick="handleSubmitVer()" ${cv.valid?'':'disabled'} style="${cv.valid?'':'opacity:.5;cursor:not-allowed'}">
        ${cv.valid?'Wunschliste einreichen âœ“':'Bitte alle Anforderungen erfÃ¼llen'}
      </button>
    </div>
  </div>
  <button onclick="showLogin()" style="position:fixed;bottom:20px;right:20px;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;color:#9ca3af">${lockSvg(18)}</button>
  ${state.showLoginModal?renderLoginModal():''}`;
}

// â”€â”€ Success Besuche â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSuccessBes(){
  const p=state.personal, cos=state.setup.companies;
  const sel=state.besuche.selected;
  const rows=sel.map((id,i)=>{const co=cos.find(c=>c.id===id);if(!co)return'';return`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #f3f4f6"><div style="width:24px;height:24px;border-radius:50%;background:#0d9488;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0">${i+1}</div><span style="flex:1;font-size:13px;font-weight:600;color:#1f2937">${co.name}</span></div>`;}).join('');
  document.getElementById('app').innerHTML=`<div class="success-page"><div class="success-card" id="snap-bes" style="max-width:400px">
    <div class="check-circle" style="background:#ccfbf1">${checkSvg(32)}</div>
    <h2 style="font-size:20px;font-weight:800;color:#1f2937;margin-bottom:4px">BesuchswÃ¼nsche eingereicht!</h2>
    <p style="color:#6b7280;font-size:13px;margin-bottom:16px">${p.name}</p>
    <div style="text-align:left;margin-bottom:20px">${rows}</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button onclick="saveSnapshotBes()" class="btn btn-teal" style="font-size:14px;padding:10px">ğŸ“¸ Als Foto speichern</button>
      <button onclick="backToForm()" class="btn btn-outline" style="font-size:14px;padding:10px">â† ZurÃ¼ck</button>
    </div>
  </div></div>`;
}

// â”€â”€ Success Versetzung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSuccessVer(){
  const p=state.personal, cos=state.setup.companies;
  const ranked=[...cos].filter(c=>state.versetzung.points[c.id]>0).sort((a,b)=>state.versetzung.points[b.id]-state.versetzung.points[a.id]);
  const total=Object.values(state.versetzung.points).reduce((a,b)=>a+b,0);
  const rows=ranked.map((c,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #f3f4f6"><div style="width:24px;height:24px;border-radius:50%;background:#6366f1;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0">${i+1}</div><span style="flex:1;font-size:13px;font-weight:600;color:#1f2937">${c.name}</span><span style="font-size:14px;font-weight:800;color:#6366f1">${state.versetzung.points[c.id]} Pts</span></div>`).join('');
  document.getElementById('app').innerHTML=`<div class="success-page"><div class="success-card" id="snap-ver" style="max-width:400px">
    <div class="check-circle">${checkSvg(32)}</div>
    <h2 style="font-size:20px;font-weight:800;color:#1f2937;margin-bottom:4px">Wunschliste eingereicht!</h2>
    <p style="color:#6b7280;font-size:13px;margin-bottom:16px">${p.name}</p>
    <div style="text-align:left;margin-bottom:12px">${rows}</div>
    <div style="background:#f9fafb;border-radius:8px;padding:8px 12px;margin-bottom:20px;display:flex;justify-content:space-between">
      <span style="font-size:13px;font-weight:600;color:#6b7280">Total</span>
      <span style="font-size:15px;font-weight:900;color:#6366f1">${total} / 100 Pts</span>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button onclick="saveSnapshotVer()" class="btn btn-green" style="font-size:14px;padding:10px">ğŸ“¸ Als Foto speichern</button>
      <button onclick="backToForm()" class="btn btn-outline" style="font-size:14px;padding:10px">â† ZurÃ¼ck</button>
    </div>
  </div></div>`;
}

// â”€â”€ Login Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLoginModal(){
  return`<div onclick="closeLogin(event)" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;display:flex;align-items:center;justify-content:center;padding:16px"><div onclick="event.stopPropagation()" style="background:#fff;border-radius:16px;padding:24px;width:100%;max-width:300px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-weight:700;font-size:16px">Admin-Login</h3><button onclick="closeLoginModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af">âœ•</button></div><input type="password" id="login-pw" placeholder="Passwort" oninput="setLoginPw(this.value)" onkeydown="if(event.key==='Enter')doLogin()" style="width:100%;padding:8px 12px;border:2px solid ${state.loginErr?'#ef4444':'#e5e7eb'};border-radius:8px;font-size:16px;outline:none;margin-bottom:${state.loginErr?'4px':'12px'}"/>${state.loginErr?'<p style="color:#ef4444;font-size:12px;margin-bottom:8px">Falsches Passwort</p>':''}<button onclick="doLogin()" class="btn btn-primary" style="font-size:14px;padding:10px">Anmelden</button></div></div>`;
}

// â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLightbox(src,name){
  return`<div onclick="closeLightbox()" style="position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;cursor:pointer">
    <div onclick="event.stopPropagation()" style="max-width:400px;width:100%;background:#fff;border-radius:16px;overflow:hidden">
      <img src="${src}" style="width:100%;display:block"/>
      <div style="padding:10px 16px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px;font-weight:600;color:#374151">${name}</span>
        <button onclick="closeLightbox()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af">âœ•</button>
      </div>
    </div>
  </div>`;
}
window.openLightbox=(src,name)=>{
  const lb=document.createElement('div');lb.id='lightbox';lb.innerHTML=renderLightbox(src,name);document.body.appendChild(lb);
};
window.closeLightbox=()=>{const lb=document.getElementById('lightbox');if(lb)lb.remove();};

// â”€â”€ Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdmin(){
  const subs_b=state.subsBes, subs_v=state.subsVer, cos=state.setup.companies, stus=state.setup.students||[];
  const s=state.setup;
  let content='';

  if(state.adminTab==='besuche'){
    const total=stus.length>0?stus.length:40;
    const pct=Math.min(100,Math.round(subs_b.length/total*100));
    // Summe pro Firma
    const firmaSums=cos.map(c=>subs_b.reduce((a,sub)=>a+((sub.selected||[]).includes(c.id)?1:0),0));
    const rows=subs_b.map((sub,i)=>{
      const fotoBtn=sub.selfie?`<img src="${sub.selfie}" onclick="openLightbox('${sub.selfie}','${(sub.name||'').replace(/'/g,"\\'")}\')" style="width:32px;height:32px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid #e5e7eb" title="Foto anzeigen"/>`:'-';
      return`<tr><td>${i+1}</td><td style="font-weight:600;white-space:nowrap">${sub.name||''}</td><td style="color:#9ca3af;font-size:11px;white-space:nowrap">${sub.timestamp||''}</td><td>${fotoBtn}</td>${cos.map(c=>`<td style="text-align:center">${(sub.selected||[]).includes(c.id)?'âœ“':''}</td>`).join('')}<td><button onclick="delSubBes('${sub._id}')" style="background:none;border:none;cursor:pointer;color:#d1d5db;padding:4px">${trashSvg(14)}</button></td></tr>`;
    }).join('');
    const sumRow=`<tr style="background:#f0fdf4;font-weight:700"><td colspan="4" style="font-weight:700;padding:7px 6px;color:#16a34a">Î£ Anzahl Stimmen</td>${firmaSums.map(s=>`<td style="text-align:center;color:#16a34a;font-weight:800">${s||''}</td>`).join('')}<td></td></tr>`;
    content=`<div class="card"><div class="card-body"><p class="section-title">Fortschritt Besuche</p><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:14px;font-weight:700">Einreichungen</span><span style="font-size:14px;font-weight:700;color:#0d9488">${subs_b.length} / ${total} (${pct}%)</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%;background:#0d9488"></div></div></div></div>
    <div class="card"><div class="card-body" style="padding:12px"><div style="display:flex;gap:8px;flex-wrap:wrap"><button onclick="exportCSVBes()" ${subs_b.length?'':'disabled'} class="btn btn-green btn-sm" style="${subs_b.length?'':'opacity:.5;cursor:not-allowed'}">${dlSvg()} CSV exportieren</button><button onclick="clearAllBes()" ${subs_b.length?'':'disabled'} class="btn btn-red btn-sm" style="${subs_b.length?'':'opacity:.5;cursor:not-allowed'}">Alle lÃ¶schen</button></div></div></div>
    ${subs_b.length>0?`<div class="card"><div class="tbl-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Zeit</th><th>Foto</th>${cos.map(c=>`<th title="${c.name}" style="text-align:center">${c.id}</th>`).join('')}<th></th></tr></thead><tbody>${rows}</tbody><tfoot>${sumRow}</tfoot></table></div><div style="padding:12px 16px;background:#f8fafc;border-top:1px solid #e5e7eb"><p style="font-size:11px;font-weight:700;color:#6b7280;margin-bottom:6px">Firmen-Legende</p><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 12px">${cos.map(c=>`<p style="font-size:11px;color:#6b7280"><span style="font-weight:700;color:#0d9488">${c.id}.</span> ${c.name}</p>`).join('')}</div></div></div>`:`<div class="card"><div class="card-body" style="text-align:center;color:#9ca3af;padding:40px">Noch keine Einreichungen.</div></div>`}`;

  } else if(state.adminTab==='versetzung'){
    const total=stus.length>0?stus.length:40;
    const pct=Math.min(100,Math.round(subs_v.length/total*100));
    const rows=subs_v.map((sub,i)=>{
      const sm=Object.values(sub.points||{}).reduce((a,b)=>a+b,0);
      const fotoBtn=sub.selfie?`<img src="${sub.selfie}" onclick="openLightbox('${sub.selfie}','${(sub.name||'').replace(/'/g,"\\'")}\')" style="width:32px;height:32px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid #e5e7eb" title="Foto anzeigen"/>`:'-';
      return`<tr><td>${i+1}</td><td style="font-weight:600;white-space:nowrap">${sub.name||''}</td><td style="color:#9ca3af;font-size:11px;white-space:nowrap">${sub.timestamp||''}</td><td>${fotoBtn}</td>${cos.map(c=>`<td style="text-align:center;font-weight:600;color:${(sub.points&&sub.points[c.id])>0?'#6366f1':'#d1d5db'}">${(sub.points&&sub.points[c.id])||'â€“'}</td>`).join('')}<td style="text-align:center;font-weight:700;color:#6366f1">${sm}</td><td><button onclick="delSubVer('${sub._id}')" style="background:none;border:none;cursor:pointer;color:#d1d5db;padding:4px">${trashSvg(14)}</button></td></tr>`;
    }).join('');
    const avgRow=cos.map(c=>{const avg=subs_v.length?subs_v.reduce((a,sub)=>a+(sub.points&&sub.points[c.id]||0),0)/subs_v.length:0;return`<td style="text-align:center;font-weight:600;color:#6366f1">${avg.toFixed(1)}</td>`;}).join('');
    content=`<div class="card"><div class="card-body"><p class="section-title">Fortschritt Versetzung</p><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:14px;font-weight:700">Einreichungen</span><span style="font-size:14px;font-weight:700;color:#6366f1">${subs_v.length} / ${total} (${pct}%)</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div></div></div>
    <div class="card"><div class="card-body" style="padding:12px"><div style="display:flex;gap:8px;flex-wrap:wrap"><button onclick="exportCSVVer()" ${subs_v.length?'':'disabled'} class="btn btn-green btn-sm" style="${subs_v.length?'':'opacity:.5;cursor:not-allowed'}">${dlSvg()} CSV exportieren</button><button onclick="clearAllVer()" ${subs_v.length?'':'disabled'} class="btn btn-red btn-sm" style="${subs_v.length?'':'opacity:.5;cursor:not-allowed'}">Alle lÃ¶schen</button></div></div></div>
    ${subs_v.length>0?`<div class="card"><div class="tbl-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Zeit</th><th>Foto</th>${cos.map(c=>`<th title="${c.name}" style="text-align:center">${c.id}</th>`).join('')}<th style="text-align:center">Î£</th><th></th></tr></thead><tbody>${rows}</tbody><tfoot style="background:#eff6ff"><tr><td colspan="4" style="font-weight:700;padding:7px 6px">âŒ€ Durchschnitt</td>${avgRow}<td></td><td></td></tr></tfoot></table></div><div style="padding:12px 16px;background:#f8fafc;border-top:1px solid #e5e7eb"><p style="font-size:11px;font-weight:700;color:#6b7280;margin-bottom:6px">Firmen-Legende</p><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 12px">${cos.map(c=>`<p style="font-size:11px;color:#6b7280"><span style="font-weight:700;color:#6366f1">${c.id}.</span> ${c.name}</p>`).join('')}</div></div></div>`:`<div class="card"><div class="card-body" style="text-align:center;color:#9ca3af;padding:40px">Noch keine Einreichungen.</div></div>`}`;

  } else { // setup
    // Lokale Kopie fÃ¼r Einstellungen â€“ wird erst beim Speichern Ã¼bernommen
    content=`
    <div class="card"><div class="card-body">
      <p class="section-title">WÃ¼nsche Besuche â€“ Sichtbarkeit</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label class="lbl">Sichtbar ab</label><input type="date" id="cfg-besVon" value="${s.besVon?s.besVon.split('T')[0]:''}"/></div>
        <div><label class="lbl">Sichtbar bis</label><input type="date" id="cfg-besBis" value="${s.besBis?s.besBis.split('T')[0]:''}"/></div>
      </div>
    </div></div>
    <div class="card"><div class="card-body">
      <p class="section-title">WÃ¼nsche Versetzung â€“ Sichtbarkeit</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label class="lbl">Sichtbar ab</label><input type="date" id="cfg-verVon" value="${s.verVon?s.verVon.split('T')[0]:''}"/></div>
        <div><label class="lbl">Sichtbar bis</label><input type="date" id="cfg-verBis" value="${s.verBis?s.verBis.split('T')[0]:''}"/></div>
      </div>
    </div></div>
    <div class="card"><div class="card-body">
      <p class="section-title">Lernende (${stus.length})</p>
      <p class="import-hint">Liste aus Excel â€“ ein Name pro Zeile:</p>
      <textarea id="stu-paste" class="mono" rows="5" placeholder="Max Muster&#10;Anna Mueller" style="margin-bottom:8px"></textarea>
      <button onclick="importStudents()" class="btn btn-primary" style="font-size:13px;padding:8px;margin-bottom:12px">Liste importieren</button>
      <div id="stu-msg" style="color:#16a34a;font-size:12px;font-weight:600;margin-bottom:4px;min-height:16px"></div>
      <div style="max-height:160px;overflow-y:auto;border:1px solid #f3f4f6;border-radius:8px;padding:4px">${stus.length?stus.map((n,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px"><span style="font-size:13px;color:#374151">${i+1}. ${n}</span><button onclick="removeStudent('${n.replace(/'/g,"\\'")}') " style="background:none;border:none;cursor:pointer;color:#d1d5db;padding:2px">${trashSvg(12)}</button></div>`).join(''):'<p style="font-size:12px;color:#9ca3af;font-style:italic;padding:8px">Noch keine Lernenden.</p>'}</div>
    </div></div>
    <div class="card"><div class="card-body">
      <p class="section-title">Firmen (${cos.length})</p>
      <p class="import-hint">Zwei Spalten aus Excel (Name TAB URL):</p>
      <textarea id="co-paste" class="mono" rows="5" placeholder="ANDRITZ Soutec AG&#9;https://www.andritz.com" style="margin-bottom:8px"></textarea>
      <button onclick="importCompanies()" class="btn btn-primary" style="font-size:13px;padding:8px;margin-bottom:12px">Firmen importieren</button>
      <div id="co-msg" style="color:#16a34a;font-size:12px;font-weight:600;margin-bottom:6px;min-height:16px"></div>
      <div style="max-height:280px;overflow-y:auto;border:1px solid #f3f4f6;border-radius:8px;padding:4px">${cos.map((co,i)=>`<div style="display:flex;gap:6px;align-items:center;padding:3px 4px"><span style="font-size:11px;color:#9ca3af;width:20px;text-align:right;flex-shrink:0">${i+1}.</span><input value="${co.name}" onchange="updateCompany(${i},'name',this.value)" style="flex:1;padding:4px 8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;outline:none"/><input value="${co.url}" onchange="updateCompany(${i},'url',this.value)" style="flex:1;padding:4px 8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;outline:none"/></div>`).join('')}</div>
    </div></div>
    <button onclick="saveSetup()" id="save-btn" class="btn btn-primary" style="font-size:14px;margin-bottom:16px">ğŸ’¾ Einstellungen speichern</button>`;
  }

  document.getElementById('app').innerHTML=`<div style="min-height:100vh;background:linear-gradient(135deg,#f5f3ff,#eff6ff);padding:16px"><div style="max-width:900px;margin:0 auto">
    <div class="card"><div class="card-body" style="display:flex;justify-content:space-between;align-items:center"><div><h1 style="font-size:18px;font-weight:800;color:#1f2937">Admin-Bereich</h1><p style="font-size:12px;color:#9ca3af">Wunschliste Versetzungsfirmen</p></div><button onclick="logout()" class="btn btn-red btn-sm">Abmelden</button></div></div>
    <div class="admin-tabs">
      <button onclick="setAdminTab('besuche')" class="tab-btn ${state.adminTab==='besuche'?'active':'inactive'}">ğŸ­ Besuche</button>
      <button onclick="setAdminTab('versetzung')" class="tab-btn ${state.adminTab==='versetzung'?'active':'inactive'}">ğŸ“Š Versetzung</button>
      <button onclick="setAdminTab('setup')" class="tab-btn ${state.adminTab==='setup'?'active':'inactive'}">âš™ï¸ Einstellungen</button>
    </div>
    ${content}
  </div></div>`;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setFormTab = (t) => { state.formTab=t; window.scrollTo(0,0); render(); };
window.showBesLocked = () => {
  const s=state.setup;
  const von=s.besVon?new Date(s.besVon).toLocaleString('de-DE'):'';
  const bis=s.besBis?new Date(s.besBis).toLocaleString('de-DE'):'';
  alert(von?`WÃ¼nsche Besuche sind ab ${von}${bis?' bis '+bis:''} zugÃ¤nglich.`:'Dieser Bereich ist noch nicht freigeschaltet.');
};
window.showVerLocked = () => {
  const s=state.setup;
  const von=s.verVon?new Date(s.verVon).toLocaleString('de-DE'):'';
  const bis=s.verBis?new Date(s.verBis).toLocaleString('de-DE'):'';
  alert(von?`WÃ¼nsche Versetzung sind ab ${von}${bis?' bis '+bis:''} zugÃ¤nglich.`:'Dieser Bereich ist noch nicht freigeschaltet.');
};

// PersÃ¶nliche Angaben
window.livePersonal = (k,v) => { state.personal[k]=v; };
window.commitPersonal = () => { render(); };
window.setPersonal = (k,v) => { state.personal[k]=v; render(); };

// Besuche
window.toggleBesuche = (id, checked) => {
  if(checked){ if(state.besuche.selected.length<8)state.besuche.selected.push(id); }
  else { state.besuche.selected=state.besuche.selected.filter(x=>x!==id); }
  render();
};

// Versetzung Slider/Stepper
window.setPointSlider = (id,v) => { applyPointUpdate(id, Math.max(0,Math.min(50,parseInt(v)||0))); };
window.setPointDirect = (id,v) => { applyPointUpdate(id, Math.max(0,Math.min(50,parseInt(v)||0))); };
window.stepPoint = (id,delta) => { applyPointUpdate(id, Math.max(0,Math.min(50,(state.versetzung.points[id]||0)+delta))); };
window.hideCompanyNow = (id) => { state.versetzung.points[id]=0; state.versetzung.hidden=[...state.versetzung.hidden,id]; state.versetzung.orderedIds=state.versetzung.orderedIds.filter(x=>x!==id); render(); };
window.showCompany = (id) => { state.versetzung.hidden=state.versetzung.hidden.filter(x=>x!==id); state.versetzung.orderedIds.push(id); render(); };
window.hideUnrated = () => { const toHide=state.versetzung.orderedIds.filter(id=>(state.versetzung.points[id]||0)===0); toHide.forEach(id=>{state.versetzung.hidden.push(id);}); state.versetzung.orderedIds=state.versetzung.orderedIds.filter(id=>(state.versetzung.points[id]||0)>0); render(); };
window.toggleHiddenDrawer = () => { state.showHidden=!state.showHidden; render(); };
window.doSort = () => { state.versetzung.orderedIds.sort((a,b)=>{const pa=state.versetzung.points[a]||0,pb=state.versetzung.points[b]||0;if(pa===0&&pb===0)return a-b;if(pa===0)return 1;if(pb===0)return -1;return pb-pa;}); state.versetzung.sortApplied=true; render(); };

// Einreichung Besuche
window.handleSubmitBes = async () => {
  const cv=computedBes(); if(!cv.valid)return;
  const p=state.personal;
  const sub={name:p.name,plz:p.plz,ort:p.ort,email:p.email,bms:p.bms,schultage:p.schultage,ferien:p.ferien,ferienText:p.ferien==='Ja'?p.ferienText:'',selfie:p.selfie,timestamp:new Date().toLocaleString('de-DE'),selected:[...state.besuche.selected]};
  await FB.saveBes(sub);
  state.view='success_bes'; render(); window.scrollTo(0,0);
};

// Einreichung Versetzung (Ãœberschreiben mÃ¶glich)
window.handleSubmitVer = async () => {
  const cv=computedVer(); if(!cv.valid)return;
  const p=state.personal;
  const sub={name:p.name,plz:p.plz,ort:p.ort,email:p.email,bms:p.bms,schultage:p.schultage,ferien:p.ferien,ferienText:p.ferien==='Ja'?p.ferienText:'',selfie:p.selfie,timestamp:new Date().toLocaleString('de-DE'),points:{...state.versetzung.points}};
  await FB.saveVer(sub); // setDoc mit gleicher ID Ã¼berschreibt automatisch
  state.view='success_ver'; render(); window.scrollTo(0,0);
};

window.backToForm = () => { state.view='form'; render(); };

// Snapshot Helper
async function loadHtml2Canvas(){if(!window.html2canvas){await new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';s.onload=res;s.onerror=rej;document.head.appendChild(s);});}}
async function shareOrDownload(canvas,filename){
  if(navigator.canShare){canvas.toBlob(async(blob)=>{const file=new File([blob],filename,{type:'image/png'});if(navigator.canShare({files:[file]})){try{await navigator.share({files:[file],title:'Meine Liste'});return;}catch(e){if(e.name==='AbortError')return;}}const link=document.createElement('a');link.download=filename;link.href=URL.createObjectURL(blob);link.click();},'image/png');}
  else{const link=document.createElement('a');link.download=filename;link.href=canvas.toDataURL('image/png');link.click();}
}

window.saveSnapshotBes = async () => { try{await loadHtml2Canvas();const canvas=await html2canvas(document.getElementById('snap-bes'),{scale:2,useCORS:true,backgroundColor:'#fff'});await shareOrDownload(canvas,`besuchswuensche_${state.personal.name.replace(/\s+/g,'_')}.png`);}catch(e){alert('Fehler: '+e.message);} };
window.saveSnapshotVer = async () => { try{await loadHtml2Canvas();const canvas=await html2canvas(document.getElementById('snap-ver'),{scale:2,useCORS:true,backgroundColor:'#fff'});await shareOrDownload(canvas,`wunschliste_${state.personal.name.replace(/\s+/g,'_')}.png`);}catch(e){alert('Fehler: '+e.message);} };

async function buildProvisionalCard(title,rows,footer,color){
  const wrap=document.createElement('div');
  wrap.style.cssText='position:fixed;left:-9999px;top:0;background:#fff;border-radius:16px;padding:24px;width:340px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif';
  wrap.innerHTML=`<div style="text-align:center;margin-bottom:16px"><div style="width:48px;height:48px;background:#ede9fe;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:24px">ğŸ“‹</div><h2 style="font-size:17px;font-weight:800;color:#1f2937;margin-bottom:2px">${title}</h2><p style="font-size:12px;color:#6b7280">${state.personal.name} Â· Provisorisch</p></div>${rows}${footer}<p style="font-size:10px;color:#9ca3af;text-align:center;margin-top:10px">Provisorisch Â· Noch nicht eingereicht</p>`;
  document.body.appendChild(wrap);
  await loadHtml2Canvas();
  const canvas=await html2canvas(wrap,{scale:2,useCORS:true,backgroundColor:'#fff'});
  document.body.removeChild(wrap);
  return canvas;
}

window.saveProvisionalBes = async () => {
  try{
    const cos=state.setup.companies, sel=state.besuche.selected;
    const rows=sel.map((id,i)=>{const co=cos.find(c=>c.id===id);if(!co)return'';return`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #f3f4f6"><div style="width:24px;height:24px;border-radius:50%;background:#0d9488;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0">${i+1}</div><span style="flex:1;font-size:13px;font-weight:600;color:#1f2937">${co.name}</span></div>`;}).join('');
    const canvas=await buildProvisionalCard('Meine BesuchswÃ¼nsche',rows,'','#0d9488');
    await shareOrDownload(canvas,`besuchswuensche_provisorisch_${state.personal.name.replace(/\s+/g,'_')}.png`);
  }catch(e){alert('Fehler: '+e.message);}
};
window.saveProvisionalVer = async () => {
  try{
    const cos=state.setup.companies, pts=state.versetzung.points;
    const ranked=[...cos].filter(c=>pts[c.id]>0).sort((a,b)=>pts[b.id]-pts[a.id]);
    const total=Object.values(pts).reduce((a,b)=>a+b,0);
    const rows=ranked.map((c,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #f3f4f6"><div style="width:24px;height:24px;border-radius:50%;background:#6366f1;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0">${i+1}</div><span style="flex:1;font-size:13px;font-weight:600;color:#1f2937">${c.name}</span><span style="font-size:14px;font-weight:800;color:#6366f1">${pts[c.id]} Pts</span></div>`).join('');
    const footer=`<div style="background:#f9fafb;border-radius:8px;padding:8px 12px;margin-top:10px;display:flex;justify-content:space-between"><span style="font-size:13px;font-weight:600;color:#6b7280">Total</span><span style="font-size:15px;font-weight:900;color:#6366f1">${total} / 100 Pts</span></div>`;
    const canvas=await buildProvisionalCard('Meine Wunschliste',rows,footer,'#6366f1');
    await shareOrDownload(canvas,`wunschliste_provisorisch_${state.personal.name.replace(/\s+/g,'_')}.png`);
  }catch(e){alert('Fehler: '+e.message);}
};

// Kamera
window.startCamera = async () => {
  state.selfieReady=false; state.selfieStreaming=true; render();
  try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:640}},audio:false});state.selfieStream=stream;const vid=document.getElementById('selfie-video');if(vid){vid.srcObject=stream;vid.muted=true;vid.onloadedmetadata=()=>{vid.play().then(()=>{const t=setInterval(()=>{if(vid.readyState>=2&&vid.videoWidth>0){state.selfieReady=true;clearInterval(t);render();}},200);});};}}
  catch(e){state.selfieStreaming=false;alert('Kamera: '+e.message);render();}
};
window.captureSelfie = () => {
  const vid=document.getElementById('selfie-video');
  const sz=Math.min(vid.videoWidth,vid.videoHeight);
  const canvas=document.createElement('canvas');canvas.width=sz;canvas.height=sz;
  canvas.getContext('2d').drawImage(vid,(vid.videoWidth-sz)/2,(vid.videoHeight-sz)/2,sz,sz,0,0,sz,sz);
  state.personal.selfie=canvas.toDataURL('image/jpeg',.8);
  stopCamera(); render();
};
window.stopCamera = () => { if(state.selfieStream){state.selfieStream.getTracks().forEach(t=>t.stop());state.selfieStream=null;} state.selfieStreaming=false; state.selfieReady=false; };
window.resetSelfie = () => { state.personal.selfie=''; startCamera(); };

// Login
window.showLogin=()=>{state.showLoginModal=true;state.loginPw='';state.loginErr=false;render();};
window.closeLoginModal=()=>{state.showLoginModal=false;render();};
window.closeLogin=(e)=>{if(e.target===e.currentTarget){state.showLoginModal=false;render();}};
window.setLoginPw=(v)=>{state.loginPw=v;};
window.doLogin=async()=>{
  const inp=document.getElementById('login-pw');
  const pw=inp?inp.value:state.loginPw;
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pw));
  const hash=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  if(hash===ADMIN_PW_HASH){state.view='admin';state.showLoginModal=false;render();}
  else{state.loginErr=true;render();setTimeout(()=>{state.loginErr=false;render();},2000);}
};
window.logout=()=>{state.view='form';render();};
window.setAdminTab=(t)=>{state.adminTab=t;render();};

// Admin Actions
window.delSubBes=async(id)=>{if(window.confirm('Eintrag lÃ¶schen?'))await FB.delBes(id);};
window.delSubVer=async(id)=>{if(window.confirm('Eintrag lÃ¶schen?'))await FB.delVer(id);};
window.clearAllBes=async()=>{if(window.confirm('Alle Besuche-Daten lÃ¶schen?'))await FB.delAllBes();};
window.clearAllVer=async()=>{if(window.confirm('Alle Versetzungs-Daten lÃ¶schen?'))await FB.delAllVer();};

window.exportCSVBes=()=>{
  const subs=state.subsBes,cos=state.setup.companies;if(!subs.length)return;
  const hdrs=['Nachname','Vorname','PLZ','Ort','BMS','Schultage','Ferien','Ferientext','E-Mail','Zeit',...cos.map(c=>c.name)];
  const rows=subs.map(s=>{
    const parts=(s.name||'').trim().split(/\s+/);
    const vorname=parts[0]||'';
    const nachname=parts.slice(1).join(' ')||'';
    return[nachname,vorname,s.plz,s.ort,s.bms,s.schultage,s.ferien,s.ferienText||'',s.email,s.timestamp,...cos.map(c=>(s.selected||[]).includes(c.id)?'x':'')];
  });
  const csv=[hdrs.join(';'),...rows.map(r=>r.join(';'))].join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}));a.download=`besuche_${new Date().toISOString().split('T')[0]}.csv`;a.click();
};
window.exportCSVVer=()=>{
  const subs=state.subsVer,cos=state.setup.companies;if(!subs.length)return;
  const hdrs=['Nachname','Vorname','PLZ','Ort','BMS','Schultage','Ferien','Ferientext','E-Mail','Zeit',...cos.map(c=>c.name),'Summe'];
  const rows=subs.map(s=>{
    const parts=(s.name||'').trim().split(/\s+/);
    const vorname=parts[0]||'';
    const nachname=parts.slice(1).join(' ')||'';
    return[nachname,vorname,s.plz,s.ort,s.bms,s.schultage,s.ferien,s.ferienText||'',s.email,s.timestamp,...cos.map(c=>s.points&&s.points[c.id]||0),Object.values(s.points||{}).reduce((a,b)=>a+b,0)];
  });
  const csv=[hdrs.join(';'),...rows.map(r=>r.join(';'))].join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}));a.download=`versetzung_${new Date().toISOString().split('T')[0]}.csv`;a.click();
};

window.importStudents=()=>{
  const ta=document.getElementById('stu-paste');if(!ta)return;
  const lines=ta.value.split(/\n/).map(l=>l.trim()).filter(Boolean);
  state.setup.students=[...new Set(lines)].sort();ta.value='';
  const msg=document.getElementById('stu-msg');
  if(msg){msg.textContent=`âœ“ ${state.setup.students.length} Lernende importiert (noch nicht gespeichert)`;setTimeout(()=>{if(msg)msg.textContent='';},3000);}
  render();
};
window.removeStudent=(n)=>{
  state.setup.students=state.setup.students.filter(x=>x!==n);
  render();
};
window.importCompanies=()=>{
  const ta=document.getElementById('co-paste');if(!ta)return;
  const lines=ta.value.split(/\n/).map(l=>l.trim()).filter(Boolean);
  state.setup.companies=lines.map((line,i)=>{const p=line.split(/\t/);return{id:i+1,name:p[0]||'',url:p[1]||''};});
  ta.value='';
  const msg=document.getElementById('co-msg');
  if(msg){msg.textContent=`âœ“ ${state.setup.companies.length} Firmen importiert (noch nicht gespeichert)`;setTimeout(()=>{if(msg)msg.textContent='';},3000);}
  render();
};
window.updateCompany=(i,field,val)=>{state.setup.companies[i][field]=val;}; // Kein sofort-save (wird beim Speichern-Button Ã¼bernommen)
window.saveSetup=async()=>{
  // Datum-Felder aus DOM lesen + Uhrzeit hinzufÃ¼gen (von: 00:00, bis: 23:59)
  const rd=(id,addTime)=>{const el=document.getElementById(id);if(!el||!el.value)return '';return el.value+(addTime||'');};
  state.setup.besVon=rd('cfg-besVon','T00:00');
  state.setup.besBis=rd('cfg-besBis','T23:59');
  state.setup.verVon=rd('cfg-verVon','T00:00');
  state.setup.verBis=rd('cfg-verBis','T23:59');
  const btn=document.getElementById('save-btn');if(btn){btn.textContent='Speichernâ€¦';btn.disabled=true;}
  await FB.saveSetup(state.setup);
  if(btn){btn.textContent='âœ“ Gespeichert!';btn.style.background='#16a34a';setTimeout(()=>{if(btn){btn.textContent='ğŸ’¾ Einstellungen speichern';btn.style.background='';btn.disabled=false;}},2000);}
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  const cfg=await FB.loadSetup();
  if(cfg){
    // Neue Feldnamen, aber auch alte (Migration)
    const migrated={...DEFAULT_SETUP,...cfg};
    if(cfg.besDeadline&&!cfg.besBis) migrated.besBis=cfg.besDeadline;
    if(cfg.verFreischalt&&!cfg.verVon) migrated.verVon=cfg.verFreischalt;
    if(cfg.verDeadline&&!cfg.verBis) migrated.verBis=cfg.verDeadline;
    state.setup=migrated;
    state.versetzung.points=emptyPoints(cfg.companies||DEFAULT_COMPANIES);
    state.versetzung.orderedIds=(cfg.companies||DEFAULT_COMPANIES).map(c=>c.id);
  } else {
    state.versetzung.points=emptyPoints(DEFAULT_COMPANIES);
  }
  // Submissions hÃ¶ren â€“ Ã¼berschreibt NICHT state.setup
  FB.subscribeBes(subs=>{state.subsBes=subs;if(state.loading){state.loading=false;}render();});
  FB.subscribeVer(subs=>{state.subsVer=subs;if(state.loading){state.loading=false;}render();});
  // Fallback falls keine Collection vorhanden
  setTimeout(()=>{if(state.loading){state.loading=false;render();}},3000);
}
init();
</script>
</body>
</html>
